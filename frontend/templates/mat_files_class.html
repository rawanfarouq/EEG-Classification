<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAT Classification</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            text-align: center;
        }
        h1 {
            color: #333;
        }
        .container {
            width: 80%;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-top: 20px;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            background-color: #e9ecef;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 4px;
        }
        .no-steps {
            color: #6c757d;
        }
        #stepsContainer {
            display: none;
        }
        #toggleButton {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #extractFeaturesButton {
            display: none; /* Initially hide the Extract CSP Features button */
            margin-top: 10px;
            padding: 10px 25px;
            background-color: #28a745; /* A green shade for success actions */
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px; /* Larger font size for better readability */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* A subtle shadow for depth */
            transition: background-color 0.3s ease; /* Smooth transition for hover effect */
        }

        #extractFeaturesButton:hover {
            background-color: #218838; /* A slightly darker green on hover for feedback */
        }

        #extractFeaturesButton:active {
            background-color: #1e7e34; /* Even darker on click to simulate a press */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2); /* Inner shadow to simulate depth */
        }

        /* Disabled state for the button */
        #extractFeaturesButton:disabled {
            background-color: #94d3a2;
            cursor: not-allowed;
        }
    
        .message-box {
            margin-top: 3rem;
            padding: 1rem;
            background-color: #dff0d8; /* Lighter green background */
            color: #515d9c; /* Dark green text that's easy on the eyes */
            border: 1px solid #ececec; /* Subtle border color */
            border-radius: 0.25rem;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mat File Classification</h1>
    </div>

    <button id="toggleButton" class="btn btn-primary my-2" onclick="toggleStepsContainer()">View Process Data</button>
    <button id="extractFeaturesButton" class="btn btn-success my-2" onclick="extractFeatures()">Extract CSP Features</button>
   
    <button id="toggleAccuracyButton" class="btn btn-info my-2" onclick="toggleAccuracyContainer()" style="display: none;">Hide Accuracy Results</button>
    <div id="modelSelectionContainer" style="display: none; margin-top: 10px;">
        <label for="modelSelect">Choose a model:</label>
        <select id="modelSelect" class="form-control">
            <option value="">Select Model</option>
            <option value="svc">SVC Model</option>
            <option value="random">Random Forest Model</option>
            <option value="logistic">Logistic Regression Model</option>
            <option value="knn">KNN Model</option>
            <option value="cnn">CNN Model</option>
        </select>
        <button id="fetchAccuracyButton" class="btn btn-info my-2" onclick="fetchModelAccuracy()">Get Accuracy</button>
    </div>
    <button id="predictButton" class="btn btn-warning my-2" onclick="redirectToPredictPage()" style="display: none;">Predict</button>


<div id="stepsContainer">
    <h2>Preprocessing Steps:</h2>
    <ul id="stepsList"></ul>
    <p id="noSteps" class="no-steps">No preprocessing steps available.</p>
</div>

<div id="cspFeaturesContainer" style="display: none;">
    <h2>CSP Features:</h2>
    <p id="successMessage" style="color: green;"></p>
</div>

<!-- Add this below the CSP Features container in mat_files_class.html -->
<div id="accuracyContainer" style="display: none;">
    <h2>Accuracy Results:</h2>
    <ul id="accuracyList" class="list-group"></ul>
</div>

<script>
    var preprocessingStepsFetched = false;
    var modelingPerformed = false;
    var fetchedPreprocessingSteps = [];

    function toggleStepsContainer() {
        var stepsContainer = document.getElementById('stepsContainer');
        var toggleButton = document.getElementById('toggleButton');

        if (stepsContainer.style.display === 'none') {
            stepsContainer.style.display = 'block';
            toggleButton.textContent = 'Hide Process Data';
            if (!preprocessingStepsFetched) {
                fetchPreprocessingSteps();
            } else {
                displayPreprocessingSteps();
            }
        } else {
            stepsContainer.style.display = 'none';
            toggleButton.textContent = 'View Process Data';
        }
    }
    

    function fetchPreprocessingSteps() {
        var stepsList = document.getElementById('stepsList');
        var noSteps = document.getElementById('noSteps');

        // Clear existing list
        stepsList.innerHTML = '';
        noSteps.style.display = 'none';
        stepsList.innerHTML = '<li>Loading...</li>';

        // AJAX call to the server to fetch preprocessing steps
        fetch('{{ url_for("file_reader.mat_classification") }}', {
            method: 'POST',
        }).then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        }).then(data => {
            if (data.error) {
                console.error('Server error:', data.error);
                stepsList.innerHTML = '<li>Error fetching steps</li>';
            } else {
                if (data.preprocessing_steps && data.preprocessing_steps.length > 0) {
                    fetchedPreprocessingSteps = data.preprocessing_steps;
                    preprocessingStepsFetched = true;
                    displayPreprocessingSteps();
                    // Show the Extract CSP Features button
                    document.getElementById('extractFeaturesButton').style.display = 'block';
                } else {
                    noSteps.style.display = 'block';
                }
            }
        }).catch(error => {
            console.error('Error:', error);
            stepsList.innerHTML = '<li>Error fetching steps</li>';
        });
    }

    function displayPreprocessingSteps() {
    var stepsList = document.getElementById('stepsList');
    stepsList.innerHTML = '';
    fetchedPreprocessingSteps.forEach(function(step) {
        var li = document.createElement('li');
        li.textContent = step;
        li.className = 'list-group-item'; // Bootstrap class for list items
        stepsList.appendChild(li);
    });
}

function extractFeatures() {
    var cspFeaturesContainer = document.getElementById('cspFeaturesContainer');
    var extractFeaturesButton = document.getElementById('extractFeaturesButton');

    if (cspFeaturesContainer.style.display === 'none') {
        // If not visible, show the features and update button text
        cspFeaturesContainer.style.display = 'block';
        extractFeaturesButton.textContent = 'Unview Extract Features';
        
        // Only fetch features and perform modeling if it hasn't been done already
        if (!modelingPerformed) {
            fetchCSPFeatures();
        }
    } else {
        // If visible, hide the features and update button text
        cspFeaturesContainer.style.display = 'none';
        extractFeaturesButton.textContent = 'View Extract Features';
    }
}

function fetchCSPFeatures() {
    fetch('{{ url_for("file_reader.extract_csp_features") }}', {
        method: 'POST',
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    }).then(data => {
        console.log("entered fetch csp")
        if (data.message) {
            console.log("entered if fetch csp")
            displaySuccessMessage(data.message); // Display the message from the server
            document.getElementById('modelSelectionContainer').style.display = 'block';
        } else {
            displayErrorMessage('No message received from server.');
        }
    }).catch(error => {
        console.error('Error:', error);
        displayErrorMessage('Error extracting features.');
    });
}



function displayLoadingAccuracy() {
    var accuracyContainer = document.getElementById('accuracyContainer');
    var accuracyList = document.getElementById('accuracyList');
    accuracyContainer.style.display = 'block';
    accuracyList.innerHTML = ''; // Clear previous results
    var loadingMessage = document.createElement('li');
    loadingMessage.textContent = 'Calculating accuracy, please wait...';
    loadingMessage.className = 'list-group-item';
    accuracyList.appendChild(loadingMessage);
}

function displayAccuracyResults(accuracyData) {
    var accuracyContainer = document.getElementById('accuracyContainer');
    var accuracyList = document.getElementById('accuracyList');
    var toggleAccuracyButton = document.getElementById('toggleAccuracyButton');

    // Clear previous results and set the display style
    accuracyList.innerHTML = '';
    accuracyContainer.style.display = 'block';
    toggleAccuracyButton.style.display = 'block';
    toggleAccuracyButton.textContent = 'Hide Accuracy Results';

    // Create a list item for each accuracy message and append it to the list
    accuracyData.forEach(function(accuracyMessage) {
        var li = document.createElement('li');
        li.className = 'list-group-item'; // Use Bootstrap class for styling
        
        // Convert the accuracy message into a formatted HTML string
        var formattedMessage = accuracyMessage.replace(/, /g, '<br>'); // Replace commas with line breaks
        li.innerHTML = formattedMessage; // Set the HTML content of the list item
        accuracyList.appendChild(li); // Append the list item to the list
    });
    document.getElementById('predictButton').style.display = 'block';

}


    function displaySuccessMessage(message) {
        // Make sure the CSP features container is visible
        document.getElementById('cspFeaturesContainer').style.display = 'block';

        var messageLines = message.split('\n');
        var formattedMessage = '<div class="message-box">';
        
        messageLines.forEach(function(line) {
            if (line.startsWith('*')) {
                formattedMessage += '<li class="list-unstyled">' + line.slice(1).trim() + '</li>';
            } else {
                formattedMessage += '<p>' + line + '</p>';
            }
        });

        formattedMessage += '</div>';

        var successMessage = document.getElementById('successMessage');
        successMessage.innerHTML = formattedMessage;
    }

    function displayErrorMessage(message) {
        var errorMessage = document.getElementById('successMessage');
        errorMessage.innerHTML = '<div class="mt-3 p-3 bg-danger text-white rounded">' + message + '</div>';
    }

    function toggleAccuracyContainer() {
        var accuracyContainer = document.getElementById('accuracyContainer');
        var toggleAccuracyButton = document.getElementById('toggleAccuracyButton');

        // Check the current display state and toggle it
        if (accuracyContainer.style.display === 'none' || accuracyContainer.style.display === '') {
            accuracyContainer.style.display = 'block';
            toggleAccuracyButton.textContent = 'Hide Accuracy Results';
        } else {
            accuracyContainer.style.display = 'none';
            toggleAccuracyButton.textContent = 'View Accuracy Results';
        }
    }

    function fetchModelAccuracy() {
    var modelSelect = document.getElementById('modelSelect');
    var model = modelSelect.value;
    var url = '';

    
    if (!model) {
        displayErrorMessage('Please select a model.');
        return;
    }
    // Determine which URL to use based on the selected model
    if (model === 'svc') {
        url = '{{ url_for("file_reader.perform_mat_modeling_svc") }}';
    } else if (model === 'random') {
        url = '{{ url_for("file_reader.perform_mat_modeling_random") }}';
    } else if (model === 'logistic') {
        url = '{{ url_for("file_reader.perform_mat_modeling_logistic") }}';
    }else if (model === 'knn') {
        url = '{{ url_for("file_reader.perform_mat_modeling_knn") }}';
    }else if (model === 'cnn') {
        url = '{{ url_for("file_reader.perform_mat_modeling_cnn") }}';
    }
    

    // Fetch the accuracy results for the selected model
    fetch(url, {
        method: 'POST',
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    }).then(data => {
        if (data.accuracy) {
            displayAccuracyResults(data.accuracy);
        } else {
            displayErrorMessage('No accuracy results received from server.');
        }
    }).catch(error => {
        console.error('Error:', error);
        displayErrorMessage('Error fetching accuracy results.');
    });
}

function redirectToPredictPage() {
    var modelSelect = document.getElementById('modelSelect');
    var selectedModel = modelSelect.value;
    if (selectedModel) {
        window.location.href = '{{ url_for("mat_predict") }}?model=' + encodeURIComponent(selectedModel);
    } else {
        // Handle the case where no model is selected before redirecting
        displayErrorMessage('Please select a model.');
    }
}

   
</script>
</body>
</html>
